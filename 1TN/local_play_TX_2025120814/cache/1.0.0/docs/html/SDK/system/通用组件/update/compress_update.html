

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.2.1. 压缩双备份升级 &mdash; JL Project Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="https://doc.zh-jieli.com/static/css/custom.css" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=fa47ad08"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="https://doc.zh-jieli.com/static/js/custom.js"></script>
      <script src="../../../../_static/js/custom.js?v=bfa33168"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="8.3. Buffer管理" href="../buf_manage/index.html" />
    <link rel="prev" title="8.2. 固件升级" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SDK入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../framework/index.html">1. 技术框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">2. 快速入门</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">主要功能介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wireless_mic/index.html">1. SDK 详细介绍</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">系统功能进阶</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../driver/index.html">1. 外设驱动</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver/pmu/index.html">2. 电源管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../key_config/index.html">3. 按键配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pwm_led/index.html">4. LED状态显示</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../file_system/index.html">5. 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../os/index.html">6. 操作系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_manager/index.html">7. 设备管理</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">8. 通用组件</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../heap/index.html">8.1. 动态内存申请</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">8.2. 固件升级</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.2.1. 压缩双备份升级</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#flash">8.2.1.1. 压缩双备份flash结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">8.2.1.2. 压缩双备份使用方法</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../buf_manage/index.html">8.3. Buffer管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cfg_user/index.html">8.4. 配置项管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debug/index.html">8.5. 软件调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timer/index.html">8.6. 定时器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clock_manage/index.html">8.7. 时钟管理</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../report/index.html">9. 系统状态报告</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resource_manage/index.html">10. 资源管理帮助</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">蓝牙功能进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../bt/btstack/index.html">1. 蓝牙协议栈</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bt/ble/index.html">2. BLE开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bt/FindMy/FindMy.html">3. FindMy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">音频功能进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../audio/index.html">1. 音频播放</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../audio_config/index.html">2. 音频配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../audio_flow/index.html">3. 音频流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../audio_effects/index.html">4. 音效调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../audio_FAQ/index.html">5. 音频FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">JieLi_蓝牙音频</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">8. </span>通用组件</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">8.2. </span>固件升级</a></li>
      <li class="breadcrumb-item active"><span class="section-number">8.2.1. </span>压缩双备份升级</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><span class="section-number">8.2.1. </span>压缩双备份升级<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p>压缩双备份升级是指在设备升级过程中，使用压缩包的方式来存储和传输升级文件，以节省存储空间和提高传输效率。该方法通常涉及将升级文件打包成一个压缩文件，并在设备上进行解压和安装。可以利用该功能扩大在普通双备份模式下的代码区空间，解决双备份模式下代码区空间不足的问题。</p>
<section id="flash">
<h2><span class="section-number">8.2.1.1. </span>压缩双备份flash结构<a class="headerlink" href="#flash" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="../../../../_images/压缩双备份flash结构.png"><img alt="压缩双备份flash结构" class="align-center" src="../../../../_images/%E5%8E%8B%E7%BC%A9%E5%8F%8C%E5%A4%87%E4%BB%BDflash%E7%BB%93%E6%9E%84.png" style="width: 30%;" />
</a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>结构基本与普通双备份flash结构相同，但appcore1区域小于appcore0区域</p></li>
<li><p>对比普通双备份flash结构，appcore0区域可以比原来增大约16%~18%空间</p></li>
<li><p>升级包传输完成后，不能立刻重启完成，需要一定解压刷flash耗时（2MB的flash约耗时10~20秒）</p></li>
</ul>
</div>
</section>
<section id="id2">
<h2><span class="section-number">8.2.1.2. </span>压缩双备份使用方法<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="sdk">
<h3><span class="section-number">8.2.1.2.1. </span>SDK配置<a class="headerlink" href="#sdk" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>在sdk_config.h中，开启宏配置</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#define TCFG_DUAL_BANK_ENABLE 1    </span><span class="c1">//双备份</span>
<span class="linenos">2</span><span class="cp">#define TCFG_UPDATE_COMPRESS 1     </span><span class="c1">//压缩升级</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../../_images/压缩双备份-可视化配置.png"><img alt="压缩双备份-可视化配置" class="align-center" src="../../../../_images/%E5%8E%8B%E7%BC%A9%E5%8F%8C%E5%A4%87%E4%BB%BD-%E5%8F%AF%E8%A7%86%E5%8C%96%E9%85%8D%E7%BD%AE.png" style="width: 60%;" />
</a>
<ul class="simple">
<li><p>在isd_config_rule.c（或isd_donwload.ini）文件中，默认的升级区AREA_SIZE参数为0</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="o">[</span>COMPRESS_BACKUP<span class="o">]</span>
<span class="linenos">2</span><span class="nv">AREA_SIZE</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w">           </span><span class="c1">#默认升级区为0，双击执行download.bat脚本查看推荐配置</span>
<span class="linenos">3</span><span class="nv">BLOCK_SIZE</span><span class="o">=</span><span class="m">65536</span><span class="p">;</span><span class="w">      </span><span class="c1">#压缩块大小，配置为64KB，不用修改</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../../_images/isd_config_ini配置初始为0.png"><img alt="isd_config_ini配置初始为0" class="align-center" src="../../../../_images/isd_config_ini%E9%85%8D%E7%BD%AE%E5%88%9D%E5%A7%8B%E4%B8%BA0.png" style="width: 30%;" />
</a>
<ul class="simple">
<li><p>可视化工程中，直接点击“编译”，可视化终端会根据固件的实际压缩率给出升级区的空间大小推荐值，（非可视化工程则在下载目录下双击执行download.bat脚本），输出如下</p></li>
</ul>
<a class="reference internal image-reference" href="../../../../_images/推荐压缩升级区配置.png"><img alt="推荐压缩升级区配置" class="align-center" src="../../../../_images/%E6%8E%A8%E8%8D%90%E5%8E%8B%E7%BC%A9%E5%8D%87%E7%BA%A7%E5%8C%BA%E9%85%8D%E7%BD%AE.png" style="width: 60%;" />
</a>
<p>推荐的压缩升级区空间大小为812K，此时还不能成功编译出固件</p>
<ul class="simple">
<li><p>在isd_config_rule.c（或isd_donwload.ini）文件中，配置升级区AREA_SIZE参数为812K</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="o">[</span>COMPRESS_BACKUP<span class="o">]</span>
<span class="linenos">2</span><span class="nv">AREA_SIZE</span><span class="o">=</span>812K<span class="p">;</span><span class="w">      </span><span class="c1">#注意单位是K，不能写KB</span>
<span class="linenos">3</span><span class="nv">BLOCK_SIZE</span><span class="o">=</span><span class="m">65536</span><span class="p">;</span><span class="w">    </span><span class="c1">#压缩块大小，配置为64KB，不用修改</span>
</pre></div>
</div>
<ul class="simple">
<li><p>再次点击“编译”（非可视化则双击执行download.bat脚本），有如下打印输出，则证明固件编译成功</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>compressing<span class="w"> </span>firmware<span class="w"> </span>data,<span class="w"> </span>please<span class="w"> </span>waiting<span class="w"> </span>...
<span class="linenos">2</span>Firmware<span class="w"> </span>data<span class="w"> </span>length:<span class="w"> </span>840K<span class="o">(</span>0xd2000<span class="o">)</span><span class="w">                        </span><span class="c1">#实际的flash.bin大小</span>
<span class="linenos">3</span>Compressed<span class="w"> </span>firmware<span class="w"> </span>data<span class="w"> </span>length:<span class="w"> </span><span class="m">553</span>.231K<span class="o">(</span>0x8a4ed<span class="o">)</span><span class="w">         </span><span class="c1">#压缩后的flash.bin压缩包大小</span>
<span class="linenos">4</span>The<span class="w"> </span>compression<span class="w"> </span>ratio<span class="w"> </span>is:<span class="w"> </span><span class="m">0</span>.341391<span class="w">                         </span><span class="c1">#压缩率</span>
<span class="linenos">5</span>The<span class="w"> </span>total<span class="w"> </span>app<span class="w"> </span>code<span class="w"> </span>area<span class="w"> </span>size:<span class="w"> </span>1188K<span class="o">(</span>0x129000<span class="o">)</span><span class="w">              </span><span class="c1">#flash.bin的总可用flash空间大小</span>
<span class="linenos">6</span>The<span class="w"> </span>free<span class="w"> </span>app<span class="w"> </span>code<span class="w"> </span>area<span class="w"> </span>size<span class="w"> </span>:<span class="w"> </span>348K<span class="o">(</span>0x57000<span class="o">)</span><span class="w">                </span><span class="c1">#flash.bin的剩余可用flash空间大小</span>
<span class="linenos">7</span>The<span class="w"> </span>total<span class="w"> </span>compress<span class="w"> </span>backup<span class="w"> </span>area<span class="w"> </span>size:<span class="w"> </span>812K<span class="o">(</span>0xcb000<span class="o">)</span><span class="w">         </span><span class="c1">#压缩OTA包的总可用flash空间大小</span>
<span class="linenos">8</span>The<span class="w"> </span>free<span class="w"> </span>compress<span class="w"> </span>backup<span class="w"> </span>area<span class="w"> </span>size<span class="w"> </span>:<span class="w"> </span><span class="m">258</span>.769K<span class="o">(</span>0x40b13<span class="o">)</span><span class="w">     </span><span class="c1">#压缩OTA包的剩余可用flash空间大小</span>
</pre></div>
</div>
<ul class="simple">
<li><p>升级区AREA_SIZE参数配置完成一次后，即分区确定！后续版本不能再修改！！否则出现OTA失败问题</p></li>
<li><p>需要修改分区空间，只能通过测试盒串口，或USB强制升级等刷机升级方式</p></li>
<li><p>若方案有无log版本与有log版本两种固件。确定分界线时应当以量产版本为准，一般以无log情况确定分界线。</p></li>
</ul>
</section>
<section id="id3">
<h3><span class="section-number">8.2.1.2.2. </span>打包工具<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>可视化工程已经配置好打包指令，无需以下的打包工具修改操作</p></li>
<li><p>使用isd_download.exe工具（版本&gt;=V4.2.68），在PC上生成压缩OTA包</p></li>
<li><p>在download.bat脚本中，加入如下指令，即可从.ufw文件中导出压缩OTA包</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>.<span class="se">\i</span>sd_download.exe<span class="w"> </span>-make-upgrade-bin<span class="w"> </span>-ufw<span class="w"> </span>update.ufw<span class="w"> </span>-output<span class="w"> </span>db_update.bin
<span class="linenos">2</span>.<span class="se">\u</span>fw_maker.exe<span class="w"> </span>-chip<span class="w"> </span>AC710N<span class="w"> </span>-enc<span class="w"> </span>-res<span class="w"> </span>db_update.bin<span class="w"> </span>-output<span class="w"> </span>update-com.ufw
</pre></div>
</div>
<ul class="simple">
<li><p>参数解释</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>isd_download.exe从ufw文件中导出压缩OTA包
<span class="linenos">2</span>-ufw：指定目标版本.ufw文件
<span class="linenos">3</span>-output：输出文件名，主动升级这里必须命名为db_update.bin
<span class="linenos">4</span>
<span class="linenos">5</span>ufw_maker.exe将压缩OTA包制作成.ufw格式文件，可用于主动升级（RCSP/测试盒无线/sd卡等升级方式）
</pre></div>
</div>
</section>
<section id="ota">
<h3><span class="section-number">8.2.1.2.3. </span>OTA<a class="headerlink" href="#ota" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>最终设备连接上手机（或其他支持主动升级的上位机，例如测试盒蓝牙，sd卡等），将update-com.ufw放到手机中，点击启动升级即可开始设备升级</p></li>
<li><p>注意！测试盒串口升级不能用update-com.ufw文件，必须使用update.ufw文件</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="8.2. 固件升级" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../buf_manage/index.html" class="btn btn-neutral float-right" title="8.3. Buffer管理" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2026, 杰理科技股份有限公司.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>