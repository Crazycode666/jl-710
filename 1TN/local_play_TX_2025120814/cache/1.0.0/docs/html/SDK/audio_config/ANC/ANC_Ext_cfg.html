

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2.7.2. ANC扩展功能说明 &mdash; JL Project Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="https://doc.zh-jieli.com/static/css/custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=fa47ad08"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="https://doc.zh-jieli.com/static/js/custom.js"></script>
      <script src="../../../_static/js/custom.js?v=bfa33168"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="2.7.3. ANC防破音配置" href="ANC_AntiSat_cfg.html" />
    <link rel="prev" title="2.7.1. ANC使用配置" href="ANC_cfg.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SDK入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../framework/index.html">1. 技术框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">2. 快速入门</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">主要功能介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wireless_mic/index.html">1. SDK 详细介绍</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">系统功能进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver/index.html">1. 外设驱动</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver/pmu/index.html">2. 电源管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../key_config/index.html">3. 按键配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pwm_led/index.html">4. LED状态显示</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/file_system/index.html">5. 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/os/index.html">6. 操作系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_manager/index.html">7. 设备管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6/index.html">8. 通用组件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/report/index.html">9. 系统状态报告</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/resource_manage/index.html">10. 资源管理帮助</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">蓝牙功能进阶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bt/btstack/index.html">1. 蓝牙协议栈</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bt/ble/index.html">2. BLE开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bt/FindMy/FindMy.html">3. FindMy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">音频功能进阶</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../audio/index.html">1. 音频播放</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">2. 音频配置</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../DAC_cfg.html">2.1. DAC配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ADC_cfg.html">2.2. ADC配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mic_capless_manual.html">2.3. 省电容麦使用指引</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Linein_cfg.html">2.4. Linein配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IIS_cfg.html">2.5. IIS配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PDM_cfg.html">2.6. PDM配置</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2.7. ANC配置</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ANC_cfg.html">2.7.1. ANC使用配置</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.7.2. ANC扩展功能说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">2.7.2.1. 名词解释</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2.7.2.2. 智能免摘</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">2.7.2.3. 风噪检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">2.7.2.4. 广域点击</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">2.7.2.5. 音量自适应</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">2.7.2.6. 贴合度检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">2.7.2.7. 耳道自适应</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cmp">2.7.2.8. 自适应CMP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#eq">2.7.2.9. 自适应EQ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id49">2.7.2.10. 全时/实时自适应</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id57">2.7.2.11. 算法业务场景互斥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id62">2.7.2.12. 扩展功能打印控制</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ANC_AntiSat_cfg.html">2.7.3. ANC防破音配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="ANC_function_cfg.html">2.7.4. ANC软件功能配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../General_cfg.html">2.8. 通用音频配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio_algo_cfg.html">2.9. 音频算法配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../codec/index.html">2.10. 编解码配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../music_palyback.html">2.11. 音乐播放配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../production_test.html">2.12. 产测配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kws.html">2.13. 离线语音识别KWS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spatial_audio.html">2.14. 空间音效</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hi_Res_Audio/index.html">2.15. Hi-Res Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Side_Tone.html">2.16. 通话监听</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio_code_size.html">2.17. 音频代码优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio_code_section.html">2.18. 音频代码段链接配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio_delay.html">2.19. 延时配置（Delay）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio_debug.html">2.20. 调试配置（debug）</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../audio_flow/index.html">3. 音频流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../audio_effects/index.html">4. 音效调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../audio_FAQ/index.html">5. 音频FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">JieLi_蓝牙音频</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">2. </span>音频配置</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">2.7. </span>ANC配置</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2.7.2. </span>ANC扩展功能说明</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="anc">
<h1><span class="section-number">2.7.2. </span>ANC扩展功能说明<a class="headerlink" href="#anc" title="Link to this heading"></a></h1>
<p><img alt="ANC扩展功能" src="../../../_images/ANC-EXT_func.jpg" /><br></p>
<section id="id1">
<h2><span class="section-number">2.7.2.1. </span>名词解释<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>名词</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>ADT</strong></p></td>
<td><p>Acoustic Detector 声音检测</p></td>
</tr>
<tr class="row-odd"><td><p><strong>SPEAK_TO_CHAT</strong></p></td>
<td><p>智能免摘</p></td>
</tr>
<tr class="row-even"><td><p><strong>WIDE_AREA_TAP</strong></p></td>
<td><p>广域点击</p></td>
</tr>
<tr class="row-odd"><td><p><strong>WIND_NOISE_DET</strong></p></td>
<td><p>风噪检测</p></td>
</tr>
<tr class="row-even"><td><p><strong>VOLUME_ADAPTIVE</strong></p></td>
<td><p>音量自适应</p></td>
</tr>
<tr class="row-odd"><td><p><strong>FIT_DET</strong></p></td>
<td><p>贴合度检测</p></td>
</tr>
<tr class="row-even"><td><p><strong>EAR_ADAPTIVE</strong></p></td>
<td><p>耳道自适应</p></td>
</tr>
<tr class="row-odd"><td><p><strong>RTANC</strong></p></td>
<td><p>Real Time ANC，全时/实时自适应</p></td>
</tr>
<tr class="row-even"><td><p><strong>RTAEQ/AEQ</strong></p></td>
<td><p>自适应EQ</p></td>
</tr>
<tr class="row-odd"><td><p><strong>RTCMP/CMP</strong></p></td>
<td><p>ANC自适应CMP</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id2">
<h2><span class="section-number">2.7.2.2. </span>智能免摘<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="id3">
<h3><span class="section-number">2.7.2.2.1. </span>功能简介<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>耳机检测到佩戴者说话的时候，暂停正在播放的音乐，切换到通透模式捕捉环境声音，使佩戴者听取外界声音方便与人交谈；如果在指定时间内没有检测到佩戴者说话，会退出免摘模式恢复播歌，切换到之前的状态。<br></p>
<ul class="simple">
<li><p>触发方式：启动后实时检测</p></li>
<li><p>输入：免摘状态</p></li>
<li><p>输出：</p>
<ul>
<li><p>免摘触发：切到通透模式、暂停播放</p></li>
<li><p>免摘退出：切回之前模式、恢复播放</p></li>
</ul>
</li>
</ul>
</section>
<section id="id4">
<h3><span class="section-number">2.7.2.2.2. </span>系统/硬件支持<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用3个麦：TALK MIC、FF MIC、FB MIC做检测，需配置<code class="docutils literal notranslate"><span class="pre">音频配置</span></code>-<code class="docutils literal notranslate"><span class="pre">ANC配置</span></code>-<code class="docutils literal notranslate"><span class="pre">左声道FF</span> <span class="pre">MIC</span></code>、<code class="docutils literal notranslate"><span class="pre">左声道FB</span> <span class="pre">MIC</span></code>和<code class="docutils literal notranslate"><span class="pre">TALK</span> <span class="pre">MIC</span></code>；旧版本SDK（<code class="docutils literal notranslate"><span class="pre">JL709N</span> <span class="pre">patch_03</span></code>以下版本或其他系列），需正确配置通话算法节点的TALK MIC</p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>智能免摘</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id5">
<h3><span class="section-number">2.7.2.2.3. </span>软件配置<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>（1）在audio_anc.h支持通过宏SPEAK_TO_CHAT_ANC_MODE_ENABLE配置可以打开智能免摘的模式<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//************************************************************************//</span>
<span class="c1">//                 ICSD ADT 相关功能配置                                  //</span>
<span class="c1">//************************************************************************//</span>
<span class="cp">#define AUDIO_ANC_WIDE_AREA_TAP_EVENT_SYNC      1</span><span class="c1">//广域点击左右耳同步使能</span>

<span class="cm">/*支持开免摘的anc模式*/</span>
<span class="cp">#define SPEAK_TO_CHAT_ANC_MODE_ENABLE			(ANC_ON_BIT)</span>

<span class="cm">/*anc on自动打开免摘，anc off自动关闭免摘*/</span>
<span class="cp">#define SPEAK_TO_CHAT_AUTO_OPEN_IN_ANC          0</span>

<span class="c1">//****************** ICSD ADT 相关功能配置 end ************************//</span>
</pre></div>
</div>
<p>（2）在audio_anc.h支持通过宏SPEAK_TO_CHAT_AUTO_OPEN_IN_ANC配置是否anc on自动打开免摘，anc off自动关闭免摘<br></p>
</section>
<section id="id6">
<h3><span class="section-number">2.7.2.2.4. </span>调试方法<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>智能免摘需原厂协助开发，开发流程如下：<br>
<img alt="开发流程" src="../../../_images/original_debug_process.png" /><br></p>
</section>
<section id="api">
<h3><span class="section-number">2.7.2.2.5. </span>API使用说明<a class="headerlink" href="#api" title="Link to this heading"></a></h3>
<p>（1）智能免摘相关的接口<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*打开智能免摘*/</span><span class="w">  </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_speak_to_chat_open</span><span class="p">();</span><span class="w">  </span>

<span class="cm">/*关闭智能免摘*/</span><span class="w">  </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_speak_to_chat_close</span><span class="p">();</span><span class="w">  </span>

<span class="cm">/*获取智能免摘是否打开*/</span><span class="w">  </span>
<span class="n">u8</span><span class="w"> </span><span class="nf">audio_speak_to_chat_is_running</span><span class="p">();</span><span class="w">  </span>

<span class="cm">/*获取智能免摘状态*/</span><span class="w">  </span>
<span class="n">u8</span><span class="w"> </span><span class="nf">get_speak_to_chat_state</span><span class="p">();</span><span class="w">  </span>

<span class="cm">/*设置免摘定时结束的时间，单位ms*/</span><span class="w">  </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_speak_to_char_end_time_set</span><span class="p">(</span><span class="n">u16</span><span class="w"> </span><span class="n">time</span><span class="p">);</span><span class="w">  </span>

<span class="cm">/*智能免摘使用demo*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_speak_to_chat_demo</span><span class="p">();</span><span class="w"> </span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2><span class="section-number">2.7.2.3. </span>风噪检测<a class="headerlink" href="#id7" title="Link to this heading"></a></h2>
<section id="id8">
<h3><span class="section-number">2.7.2.3.1. </span>功能简介<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<p>在ANC（主动降噪）系统中，风噪是一种低中频、非平稳噪声，ANC模式下会引入”呼呼”的噪声；通过实时检测风噪强度并动态调节ANC增益，在抑制风噪异响与保持降噪深度之间实现最优平衡。<br></p>
<ul class="simple">
<li><p>触发方式：启动后实时检测</p></li>
<li><p>输入：风噪阈值，最多划分5个等级</p></li>
<li><p>输出：调ANC增益，默认调FF，可选FB、FF+FB（视CPU支持情况）</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FF/FB独立增益</p></td>
<td><p>×</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id9">
<h3><span class="section-number">2.7.2.3.2. </span>系统/硬件支持<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 单馈FF（TALK+FF）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：TALK MIC和FF MIC做检测，需配置<code class="docutils literal notranslate"><span class="pre">音频配置</span></code>-<code class="docutils literal notranslate"><span class="pre">ANC配置</span></code>-<code class="docutils literal notranslate"><span class="pre">左声道FF</span> <span class="pre">MIC</span></code>和<code class="docutils literal notranslate"><span class="pre">TALK</span> <span class="pre">MIC</span></code>；旧版本SDK（<code class="docutils literal notranslate"><span class="pre">JL709N</span> <span class="pre">patch_03</span></code>以下版本或其他系列），需正确配置通话算法节点的TALK MIC</p></li>
</ul>
</li>
<li><p><strong>头戴式 单馈FF / 头戴式 混合馈HYBRID</strong></p>
<ul>
<li><p>使用2个麦：LFF MIC和RFF MIC做检测</p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>风噪检测</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id10">
<h3><span class="section-number">2.7.2.3.3. </span>软件配置<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<p>（1）可通过串口打印或者在icsd_adt_app.h里面打开ICSD_ADT_WIND_INFO_SPP_DEBUG_EN，然后用手机蓝牙串口工具连接样机接收风噪值<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/* 通过蓝牙spp发送风噪信息</span>
<span class="cm"> * 需要同时打开TCFG_BT_SUPPORT_SPP和APP_ONLINE_DEBUG*/</span>
<span class="cp">#define ICSD_ADT_WIND_INFO_SPP_DEBUG_EN  1</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3><span class="section-number">2.7.2.3.4. </span>调试方法<a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<p>（1） <mark><strong>SDK版本 <code class="docutils literal notranslate"><span class="pre">JL709N</span> <span class="pre">patch_03</span></code>及以上版本，支持客户自主调试，可参考《JL实时自适应调试指南》</strong><mark><br></p>
<ul class="simple">
<li><p>调试完成后导出anc_ext.bin 下载到小机</p>
<ul>
<li><p>anc_ext.bin 文件路径：.\SDK\cpu\br**\tools\anc_ext.bin</p></li>
</ul>
</li>
</ul>
<p>（2）<strong>旧版本SDK及其他系列，风噪检测需原厂协助开发, 开发流程如下：<br></strong></p>
<ol class="arabic simple">
<li><p>开发流程图<br>
<img alt="开发流程" src="../../../_images/original_debug_process.png" /><br>
<br></p></li>
<li><p>在程序icsd_adt_app.c的wind_lvl_det_anc参数里面，可配置5个风噪阈值划分6个不同的风噪等级（包括无风档位）<br></p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*风噪输出等级:0~255*/</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">lvl1_thr</span><span class="p">;</span><span class="w">   </span><span class="c1">//阈值1</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">lvl2_thr</span><span class="p">;</span><span class="w">   </span><span class="c1">//阈值2</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">lvl3_thr</span><span class="p">;</span><span class="w">   </span><span class="c1">//阈值3</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">lvl4_thr</span><span class="p">;</span><span class="w">   </span><span class="c1">//阈值4</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">lvl5_thr</span><span class="p">;</span><span class="w">   </span><span class="c1">//阈值5</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">u16</span><span class="w"> </span><span class="n">dithering_step</span><span class="p">;</span><span class="w"> </span><span class="c1">//消抖风噪等级间距</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">last_lvl</span><span class="p">;</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">cur_lvl</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wind_lvl_det_t</span><span class="p">;</span>
<span class="n">wind_lvl_det_t</span><span class="w"> </span><span class="n">wind_lvl_det_anc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">lvl1_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">lvl2_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">lvl3_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">lvl4_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">lvl5_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">dithering_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">last_lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">cur_lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>在程序icsd_adt_app.c的audio_anc_wind_noise_process函数里面，可以设置不同风噪等级下的ANC增益<br></p></li>
</ol>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/*anc风噪检测的处理*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_anc_wind_noise_process</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">wind_lvl</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="p">...</span>

<span class="w">    </span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">adt_wind_gain_lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anc_wind_noise_lvl</span><span class="p">;</span>

<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16384</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*根据风噪等级改变anc增益*/</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">anc_wind_noise_lvl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL0</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16384</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL1</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL2</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8000</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL3</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6000</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL4</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3000</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL5</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ANC_WIND_NOISE_LVL_MAX</span><span class="p">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">anc_fade_gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">   </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3><span class="section-number">2.7.2.3.5. </span>API使用说明<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>（1）风噪检测相关的api接口<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*打开风噪检测*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_icsd_wind_detect_open</span><span class="p">();</span>
<span class="cm">/*关闭风噪检测*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_icsd_wind_detect_close</span><span class="p">();</span><span class="w"> </span>

<span class="cm">/*获取风噪等级*/</span>
<span class="n">u8</span><span class="w"> </span><span class="nf">get_audio_icsd_wind_lvl</span><span class="p">();</span>

<span class="cm">/*风噪检测使用demo*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_icsd_wind_detect_demo</span><span class="p">();</span><span class="w"> </span>
</pre></div>
</div>
<p>（2）在程序icsd_adt_app.c的wind_info_anc结构体参数里面，可通过fade_in_time和fade_out_time两个成员
变量配置不同风噪等级的淡入淡出时间，单位是秒<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u16</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="c1">//定时器定时计算时间, ms</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">fade_timer</span><span class="p">;</span><span class="c1">//计算定时器</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">wind_cnt</span><span class="p">;</span><span class="c1">//记录单次定时器的风噪帧数</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">wind_eng</span><span class="p">;</span><span class="c1">//记录风噪等级累加数字</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">last_lvl</span><span class="p">;</span><span class="c1">//记录上一次风噪等级</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">preset_lvl</span><span class="p">;</span><span class="c1">//记录当前检测到的风噪等级</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">fade_in_cnt</span><span class="p">;</span><span class="c1">//记录风噪变大的次数</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">fade_out_cnt</span><span class="p">;</span><span class="c1">//记录风噪变小的次数</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">wind_process_flag</span><span class="p">;</span><span class="c1">//是否条件anc增益</span>

<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">fade_in_time</span><span class="p">;</span><span class="c1">//设置淡入时间，单位s，误差1s</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">fade_out_time</span><span class="p">;</span><span class="c1">//设置淡出时间，单位s，误差1s</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ratio_thr</span><span class="p">;</span><span class="c1">//设置判断阈值百分比，范围：0~1</span>
<span class="p">}</span><span class="w"> </span><span class="n">wind_info_t</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="n">wind_info_t</span><span class="w"> </span><span class="n">wind_info_anc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">//ms</span>
<span class="w">    </span><span class="p">.</span><span class="n">fade_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">wind_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">wind_eng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">last_lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">preset_lvl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">fade_in_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">fade_out_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">wind_process_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">fade_in_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="c1">//s</span>
<span class="w">    </span><span class="p">.</span><span class="n">fade_out_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="c1">//s</span>
<span class="w">    </span><span class="p">.</span><span class="n">ratio_thr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">,</span>
<span class="p">};</span>

</pre></div>
</div>
</section>
</section>
<section id="id13">
<h2><span class="section-number">2.7.2.4. </span>广域点击<a class="headerlink" href="#id13" title="Link to this heading"></a></h2>
<section id="id14">
<h3><span class="section-number">2.7.2.4.1. </span>功能简介<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>使用麦克风检测点击后脸颊或者耳廓的的情况当作按键使用，减少硬件成本<br></p>
<ul class="simple">
<li><p>触发方式：启动后实时检测</p></li>
<li><p>输入：广域点击标志</p></li>
<li><p>输出：对应按键事件</p></li>
</ul>
</section>
<section id="id15">
<h3><span class="section-number">2.7.2.4.2. </span>系统/硬件支持<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 混合馈（FF+FB）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>广域点击</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id16">
<h3><span class="section-number">2.7.2.4.3. </span>软件配置<a class="headerlink" href="#id16" title="Link to this heading"></a></h3>
<p>（1）在audio_anc.h通过宏AUDIO_ANC_WIDE_AREA_TAP_EVENT_SYNC配置是否把单耳点击事件同步到对耳<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="c1">//************************************************************************//</span>
<span class="c1">//                 ICSD ADT 相关功能配置                                  //</span>
<span class="c1">//************************************************************************//</span>
<span class="cp">#define AUDIO_ANC_WIDE_AREA_TAP_EVENT_SYNC      1</span><span class="c1">//广域点击左右耳同步使能</span>

<span class="cm">/*支持开免摘的anc模式*/</span>
<span class="cp">#define SPEAK_TO_CHAT_ANC_MODE_ENABLE			(ANC_ON_BIT)</span>

<span class="cm">/*anc on自动打开免摘，anc off自动关闭免摘*/</span>
<span class="cp">#define SPEAK_TO_CHAT_AUTO_OPEN_IN_ANC          0</span>

<span class="c1">//****************** ICSD ADT 相关功能配置 end ************************//</span>

</pre></div>
</div>
</section>
<section id="id17">
<h3><span class="section-number">2.7.2.4.4. </span>调试方法<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>广域点击需原厂协助开发，开发流程如下：<br>
<img alt="开发流程" src="../../../_images/original_debug_process.png" /><br></p>
</section>
<section id="id18">
<h3><span class="section-number">2.7.2.4.5. </span>API使用说明<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>（1）广域点击相关的api接口<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*打开广域点击*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_wat_click_open</span><span class="p">();</span>

<span class="cm">/*关闭广域点击*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_wat_click_close</span><span class="p">();</span>

<span class="cm">/*广域点击使用demo*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_wat_click_demo</span><span class="p">();</span>
</pre></div>
</div>
<p>（2）在icsd_adt_app.c的audio_wat_area_tap_event_handle()函数里面配置不同点击下的响应事件<br></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/*广域点击事件处理*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_wat_area_tap_event_handle</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">wat_result</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">wat_result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">WIND_AREA_TAP_DOUBLE_CLICK</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/*音乐暂停播放*/</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">bt_get_call_status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BT_CALL_OUTGOING</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="p">(</span><span class="n">bt_get_call_status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BT_CALL_ALERT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bt_cmd_prepare</span><span class="p">(</span><span class="n">USER_CTRL_HFP_CALL_HANGUP</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bt_get_call_status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BT_CALL_INCOMING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bt_cmd_prepare</span><span class="p">(</span><span class="n">USER_CTRL_HFP_CALL_ANSWER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bt_get_call_status</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BT_CALL_ACTIVE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bt_cmd_prepare</span><span class="p">(</span><span class="n">USER_CTRL_HFP_CALL_HANGUP</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bt_cmd_prepare</span><span class="p">(</span><span class="n">USER_CTRL_AVCTP_OPID_PLAY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">WIND_AREA_TAP_THIRD_CLICK</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/*anc切模式*/</span>
<span class="w">        </span><span class="n">anc_mode_next</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">WIND_AREA_TAP_MULTIPLE_CLICK</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/* tone_play_index(IDEX_TONE_NUM_4, 0); */</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id19">
<h2><span class="section-number">2.7.2.5. </span>音量自适应<a class="headerlink" href="#id19" title="Link to this heading"></a></h2>
<section id="id20">
<h3><span class="section-number">2.7.2.5.1. </span>功能简介<a class="headerlink" href="#id20" title="Link to this heading"></a></h3>
<p>根据当前环境噪声的大小，自动设置当前播歌音量的大小，环境噪声越大，设置的播歌音量越大，避免噪声把音乐声覆盖而导致听不到播歌的音乐声<br></p>
<ul class="simple">
<li><p>输入：环境噪声阈值</p></li>
<li><p>输出：播歌音量</p></li>
</ul>
</section>
<section id="id21">
<h3><span class="section-number">2.7.2.5.2. </span>系统/硬件支持<a class="headerlink" href="#id21" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 混合馈（FF+FB）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>音量自适应</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id22">
<h3><span class="section-number">2.7.2.5.3. </span>软件配置<a class="headerlink" href="#id22" title="Link to this heading"></a></h3>
<p>（1）可通过串口打印或者在icsd_adt_app.h里面打开ICSD_ADT_VOL_NOISE_LVL_SPP_DEBUG_EN，然后用手机蓝牙串口工具连接样机接收噪声大小信息<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/* 通过蓝牙spp发送噪声大小信息</span>
<span class="cm"> * 需要同时打开TCFG_BT_SUPPORT_SPP和APP_ONLINE_DEBUG*/</span>
<span class="cp">#define ICSD_ADT_VOL_NOISE_LVL_SPP_DEBUG_EN  1</span>
</pre></div>
</div>
</section>
<section id="id23">
<h3><span class="section-number">2.7.2.5.4. </span>调试方法<a class="headerlink" href="#id23" title="Link to this heading"></a></h3>
<p>（1）音量自适应需原厂协助开发，开发流程如下：<br>
<img alt="开发流程" src="../../../_images/original_debug_process.png" /><br></p>
<p>（2）在icsd_adt_app.c的avc_parm结构体里面配置音量自动调节逻辑参数<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">adaptive_vol_param</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">noise_lvl_thr</span><span class="p">;</span><span class="cm">/*噪声阈值*/</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">offset_dB</span><span class="p">;</span><span class="cm">/*小于噪声阈值的音量偏移*/</span>
<span class="p">};</span>
<span class="cm">/*将音量划分5个不同的区间，每一个区间下，不同大小的噪声，设置不同的音量偏移大小*/</span>
<span class="cp">#define VOLUME_LEVEL    5</span>
<span class="cm">/*将噪声大小划分6个等级*/</span>
<span class="cp">#define NOISE_LEVEL     6</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">adaptive_vol_param</span><span class="w"> </span><span class="n">avc_parm</span><span class="p">[</span><span class="n">VOLUME_LEVEL</span><span class="p">][</span><span class="n">NOISE_LEVEL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/*第1区间的音量: cur_vol &lt; max_vol * 1/VOLUME_LEVEL*/</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="c1">//噪声小于40，音量+0dB</span>
<span class="w">        </span><span class="p">{</span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span><span class="c1">//噪声在40~45，音量+8dB</span>
<span class="w">        </span><span class="p">{</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">},</span><span class="c1">//噪声在45~50，音量+16dB</span>
<span class="w">        </span><span class="p">{</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">},</span><span class="c1">//噪声在50~60，音量+20dB</span>
<span class="w">        </span><span class="p">{</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="cp">#if (VOLUME_LEVEL &gt;= 2)</span>
<span class="w">    </span><span class="cm">/*第2区间的音量: cur_vol &lt; max_vol * 2/VOLUME_LEVEL , cur_vol &gt;= max_vol * 1/VOLUME_LEVEL*/</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>参数配置说明：</strong><br>
默认参数里面，把音量从小到大划分5个区间，在每个音量区间内，再把噪声大小划分6个等级，每个噪声等级对应设置一个音量的变化大小，音量变化单位dB。参数支持自行增加或者减小音量区间数量和噪声等级数量。</p></li>
</ul>
</section>
<section id="id24">
<h3><span class="section-number">2.7.2.5.5. </span>API使用说明<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<p>（1）音量自适应相关的api接口<br></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*打开音量自适应*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_icsd_adaptive_vol_open</span><span class="p">();</span>

<span class="cm">/*关闭音量自适应*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_icsd_adaptive_vol_close</span><span class="p">();</span>

<span class="cm">/*音量自适应使用demo*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_icsd_adaptive_vol_demo</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="id25">
<h2><span class="section-number">2.7.2.6. </span>贴合度检测<a class="headerlink" href="#id25" title="Link to this heading"></a></h2>
<section id="id26">
<h3><span class="section-number">2.7.2.6.1. </span>功能简介<a class="headerlink" href="#id26" title="Link to this heading"></a></h3>
<p>贴合度检测是指通过播放提示音，麦克风收集耳道佩戴特征信息，输出贴合度阈值; 提示用户是否已佩戴好耳机，通过手动调整至合适的佩戴位置，以享受最佳音质或降噪体验。</p>
<ul class="simple">
<li><p>触发方式：主动调用1次，播放提示音</p></li>
<li><p>输入：耳道/佩戴信息</p></li>
<li><p>输出：贴合度阈值（分档 佩戴松/正常/紧）</p></li>
</ul>
</section>
<section id="id27">
<h3><span class="section-number">2.7.2.6.2. </span>系统/硬件支持<a class="headerlink" href="#id27" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 带有FB MIC的方案</strong></p>
<ul>
<li><p>使用1个麦：FB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>贴合度检测</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id28">
<h3><span class="section-number">2.7.2.6.3. </span>软件配置<a class="headerlink" href="#id28" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>提示音配置</strong>：配置如下图，<strong>默认SDK使用耳道自适应的提示音</strong>，贴合度检测需要特殊的提示音，需要质量比较好的提示音格式，如MTY/SBC等：
<img alt="贴合度检测提示音" src="../../../_images/ANC-ear_adaptive_tone.jpg" /><br>
<br></p></li>
<li><p>提示音配置位置</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径 icsd_afq_app.c</span>
<span class="c1">//AFQ提示音文件选择</span>
<span class="cp">#define AUDIO_AFQ_TONE_FILE_SEL              get_tone_files()-&gt;anc_adaptive</span>
</pre></div>
</div>
<ul class="simple">
<li><p>贴合度阈值配置</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">    佩戴松紧度阈值thr</span>
<span class="cm">    1、thr &gt; DOT_NORM_THR                    判定:紧</span>
<span class="cm">    2、DOT_NORM_THR &gt;= thr &gt; DOT_LOOSE_THR   判定:正常</span>
<span class="cm">    3、DOT_LOOSE_THR  &gt;= thr                 判定:松</span>
<span class="cm">*/</span>
<span class="cp">#define ICSD_DOT_NORM_THR                    0.0f</span>
<span class="cp">#define ICSD_DOT_LOOSE_THR                  -6.0f</span>
</pre></div>
</div>
</section>
<section id="id29">
<h3><span class="section-number">2.7.2.6.4. </span>调试方法<a class="headerlink" href="#id29" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>通过主动调用api接口触发贴合度检测</p></li>
<li><p>分别佩戴 松/正常/紧，根据打印得到该样机的贴合度阈值（注意因样机不同，得到的贴合度范围可能差异较大）</p>
<ul>
<li><p>贴合度阈值相关性：松 &lt; 正常 &lt; 紧</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">38.825</span><span class="p">]</span><span class="o">=========================================</span> 
<span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">38.825</span><span class="p">]</span>                    <span class="n">dot</span> <span class="n">db</span> <span class="o">=</span> <span class="mi">85</span><span class="o">/</span><span class="mi">100</span> 
<span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">38.825</span><span class="p">]</span><span class="o">=========================================</span> 
<span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">38.825</span><span class="p">]</span> <span class="n">dot</span><span class="p">:</span> <span class="n">tight</span> 
</pre></div>
</div>
<ul class="simple">
<li><p>多个样机，多次不同佩戴，根据阈值分布划分档位；可将贴合度阈值上报至APP 分档提示</p></li>
</ul>
</section>
<section id="id30">
<h3><span class="section-number">2.7.2.6.5. </span>API使用说明<a class="headerlink" href="#id30" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径 icsd_demo.c</span>

<span class="cm">/*</span>
<span class="cm">   贴合度运行结束回调</span>
<span class="cm">	param: result 贴合度阈值，用户判断松紧度</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_dot_end_result</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     	AUDIO_FIT_DET_RESULT_TIGHT</span>
<span class="cm">    	AUDIO_FIT_DET_RESULT_NORMAL</span>
<span class="cm">    	AUDIO_FIT_DET_RESULT_LOOSE</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;dot end %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*********************************************************************</span>
<span class="cm">*                  audio_dot_app_open</span>
<span class="cm">* Description: 单次（贴合度检测）</span>
<span class="cm">* Note(s)    : 播提示音 + 贴合度检测, 运行结束调用audio_dot_end_result</span>
<span class="cm">*********************************************************************</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_dot_app_open</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//选择数据来源AFQ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fre_sel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AUDIO_ADAPTIVE_FRE_SEL_AFQ</span><span class="p">;</span>

<span class="cp">#if TCFG_AUDIO_FIT_DET_ENABLE</span>
<span class="w">    </span><span class="c1">//1. 注册 贴合度检测 流程</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">audio_icsd_dot_open</span><span class="p">(</span><span class="n">fre_sel</span><span class="p">,</span><span class="w"> </span><span class="n">audio_dot_end_result</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fit_det open fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">__exit</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if TCFG_AUDIO_FREQUENCY_GET_ENABLE</span>
<span class="w">    </span><span class="c1">//2.播放提示音-启动算法流程</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">audio_icsd_afq_open</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;afq open fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">__exit</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="nl">__exit</span><span class="p">:</span><span class="w">	</span><span class="c1">//处理启动异常的问题</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fail process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if TCFG_AUDIO_FIT_DET_ENABLE</span>
<span class="w">    </span><span class="n">audio_icsd_dot_close</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
</section>
</section>
<section id="id31">
<h2><span class="section-number">2.7.2.7. </span>耳道自适应<a class="headerlink" href="#id31" title="Link to this heading"></a></h2>
<section id="id32">
<h3><span class="section-number">2.7.2.7.1. </span>功能简介<a class="headerlink" href="#id32" title="Link to this heading"></a></h3>
<p>ANC降噪效果与耳机佩戴松紧度，以及用户的耳道差异息息相关；耳道自适应技术，通过麦克风收集用户耳道特性和佩戴情况的声学特征信息，自适应调整降噪参数，以提供更加舒适和个性化的降噪体验；</p>
<ul class="simple">
<li><p>优势：补全不同人耳道的佩戴差异</p></li>
<li><p>触发方式：主动调用1次，播放提示音，生成符合当前耳道的滤波器</p></li>
<li><p>输入：耳道/佩戴信息</p></li>
<li><p>输出：调滤波器/增益。</p></li>
</ul>
</section>
<section id="id33">
<h3><span class="section-number">2.7.2.7.2. </span>系统/硬件支持<a class="headerlink" href="#id33" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 混合馈（FF+FB）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
<li><p><strong>头戴式 混合馈（LFF+LFB+RFF+RFB）</strong></p>
<ul>
<li><p>使用4个麦：LFF MIC、LFB MIC、RFF MIC、RFB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>耳道自适应</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id34">
<h3><span class="section-number">2.7.2.7.3. </span>软件配置<a class="headerlink" href="#id34" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>提示音配置</strong>：配置如下图，自适应需要特殊的提示音，会提供默认提示音<code class="docutils literal notranslate"><span class="pre">Adaptive</span> <span class="pre">ANC</span> <span class="pre">Tone1/2/3</span></code>，需要质量比较好的提示音格式，如MTY/SBC等，如需自定义提示音，可将提示音发给原厂检查是否满足要求：
<img alt="耳道自适应提示音" src="../../../_images/ANC-ear_adaptive_tone.jpg" /><br>
<br></p></li>
<li><p>每次切降噪模式，都触发耳道自适应，配置以下宏定义即可</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define ANC_EAR_ADAPTIVE_EVERY_TIME		1   </span><span class="cm">/*每次切ANC_ON都进行自适应*/</span>
</pre></div>
</div>
</section>
<section id="id35">
<h3><span class="section-number">2.7.2.7.4. </span>调试方法<a class="headerlink" href="#id35" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>自适应参数配置及调试方法：参考《JL耳道自适应调试指南》，导出anc_ext.bin下载到小机</p></li>
<li><p>anc_ext.bin 文件路径：.\SDK\cpu\br**\tools\anc_ext.bin</p></li>
</ul>
</section>
<section id="id36">
<h3><span class="section-number">2.7.2.7.5. </span>API使用说明<a class="headerlink" href="#id36" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/*自适应模式-重新检测</span>
<span class="cm"> * param: tws_sync_en          1 TWS同步自适应，支持TWS降噪平衡，需左右耳一起调用此接口</span>
<span class="cm"> *                             0 单耳自适应, 不支持TWS降噪平衡，可TWS状态下单耳自适应</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_mode_ear_adaptive</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">tws_sync_en</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   强制中断自适应</span>
<span class="cm">   param: default_flag		1 退出后恢复默认ANC效果； 0 退出后保持ANC_OFF(避免与下一个切模式流程冲突)</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">anc_ear_adaptive_forced_exit</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">default_flag</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   自适应/普通参数切换（只切换参数）</span>
<span class="cm">	param:  mode 		0 使用普通参数; 1 使用自适应参数</span>
<span class="cm">			tone_play 	0 不播放提示音；1 播放提示音</span>
<span class="cm">			update_flag 0 不更新效果；	1 即时更新效果</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_coeff_adaptive_set</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">tone_play</span><span class="p">);</span>

<span class="cm">/*ANC滤波器模式循环切换*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_coeff_adaptive_switch</span><span class="p">();</span>

<span class="cm">/*当前ANC滤波器模式获取 0:普通参数 1:自适应参数*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_coeff_mode_get</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

</pre></div>
</div>
</section>
<section id="id37">
<h3><span class="section-number">2.7.2.7.6. </span>示例代码<a class="headerlink" href="#id37" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//切换耳道自适应滤波器，更新效果</span>
<span class="n">audio_anc_coeff_adaptive_set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">//切换自适应滤波器</span>
<span class="n">audio_anc_param_reset</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">           </span><span class="c1">//（可选）复位ANC，更新参数效果；需在ANC模式下</span>

<span class="c1">//切换默认滤波器，更新效果</span>
<span class="n">audio_anc_coeff_adaptive_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">//切换默认滤波器</span>
<span class="n">audio_anc_param_reset</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">           </span><span class="c1">//（可选）复位ANC，更新参数效果；需在ANC模式下</span>
</pre></div>
</div>
</section>
<section id="faq">
<h3><span class="section-number">2.7.2.7.7. </span>FAQ<a class="headerlink" href="#faq" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Q: <strong>耳道自适应的场景互斥问题</strong></p>
<ul>
<li><p>A:</p>
<ul>
<li><p>前置条件：ANC模式下支持进入耳道自适应；</p></li>
<li><p>播歌：会打断背景音乐，等自适应完成之后再继续播放</p></li>
<li><p>通话：不支持耳道自适应；</p></li>
<li><p>其他功能互斥：智能免摘/贴合度检测/场景自适应等功能，SDK 默认会关闭，等自适应完成再打开；</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Q: <strong>耳道自适应的参数是如何保存的？</strong></p>
<ul>
<li><p>A: 耳道自适应的参数是保存在vm中的，自适应结束会使用自适应参数，并保存到vm，后续切降噪模式都会使用自适应参数，如果需要恢复默认ANC参数则调用<code class="docutils literal notranslate"><span class="pre">audio_anc_coeff_adaptive_set</span></code>接口设置</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="cmp">
<h2><span class="section-number">2.7.2.8. </span>自适应CMP<a class="headerlink" href="#cmp" title="Link to this heading"></a></h2>
<section id="id38">
<h3><span class="section-number">2.7.2.8.1. </span>功能简介<a class="headerlink" href="#id38" title="Link to this heading"></a></h3>
<p>ANC Music Cancel滤波器（简称CMP）的参数一般参考耳道金机佩戴手动拟合，当佩戴差异较大时，默认CMP滤波器贴合不准，影响耳机音质，在<strong>TWS半入耳方案</strong>方案中问题表现更加明显；自适应CMP根据耳道状态自适应调整CMP的参数，改善音质体验；</p>
<ul class="simple">
<li><p>触发方式：跟随耳道自适应/实时自适应输出, <strong>建议有ANC自适应的产品同步打开此功能</strong></p></li>
<li><p>输入：耳道自适应/实时自适应 输出的耳道频响信息</p></li>
<li><p>输出：ANC CMP滤波器参数</p></li>
</ul>
</section>
<section id="id39">
<h3><span class="section-number">2.7.2.8.2. </span>系统/硬件支持<a class="headerlink" href="#id39" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 混合馈（FF+FB）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
<li><p><strong>头戴式 混合馈（LFF+LFB+RFF+RFB）</strong></p>
<ul>
<li><p>使用4个麦：LFF MIC、LFB MIC、RFF MIC、RFB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>自适应CMP</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id40">
<h3><span class="section-number">2.7.2.8.3. </span>调试方法<a class="headerlink" href="#id40" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>自适应CMP参数配置及调试方法：参考以下文档，导出anc_ext.bin下载到小机</p>
<ul>
<li><p>单次耳道自适应CMP：参考《JL耳道自适应调试指南》</p></li>
<li><p>实时自适应CMP：参考《JL实时自适应调试指南》</p></li>
</ul>
</li>
<li><p>anc_ext.bin 文件路径：.\SDK\cpu\br**\tools\anc_ext.bin</p></li>
</ul>
</section>
<section id="id41">
<h3><span class="section-number">2.7.2.8.4. </span>API使用说明<a class="headerlink" href="#id41" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>嵌套在耳道自适应/实时自适应启动接口中，没有单独的API开关</p></li>
</ul>
</section>
</section>
<section id="eq">
<h2><span class="section-number">2.7.2.9. </span>自适应EQ<a class="headerlink" href="#eq" title="Link to this heading"></a></h2>
<p>根据耳道结构/佩戴差异，自适应调整EQ滤波器；避免因佩戴松紧度差异，导致EQ频段失衡导致音乐低频被过度抵消或放大的问题；</p>
<ul class="simple">
<li><p>触发方式：跟随耳道自适应/实时自适应输出, 或主动调用AEQ接口触发</p></li>
<li><p>输入：耳道自适应/实时自适应 输出的耳道频响信息、AEQ接口独立获取的频响信息</p></li>
<li><p>输出：EQ滤波器</p></li>
</ul>
<section id="id42">
<h3><span class="section-number">2.7.2.9.1. </span>功能简介<a class="headerlink" href="#id42" title="Link to this heading"></a></h3>
</section>
<section id="id43">
<h3><span class="section-number">2.7.2.9.2. </span>系统/硬件支持<a class="headerlink" href="#id43" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 2MIC 混合馈（FF+FB）、 TWS 3MIC 方案（TALK+FF+FB）</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>自适应EQ</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id44">
<h3><span class="section-number">2.7.2.9.3. </span>软件配置<a class="headerlink" href="#id44" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>功能绑定</strong>：</p>
<ul>
<li><p><strong>贴合度检测</strong>：因为AEQ需要根据贴合度调整EQ参数，所以需要绑定贴合度检测功能</p></li>
</ul>
</li>
</ul>
<p><img alt="贴合度检测使能" src="../../../_images/aeq_fit_det_en.png" /><br></p>
<ul class="simple">
<li><p><strong>AEQ节点配置</strong>：如下图，<mark>需在<code class="docutils literal notranslate"><span class="pre">音频流程</span></code>-<code class="docutils literal notranslate"><span class="pre">媒体</span></code> 数据流中添加EQ节点，并命名为<strong>AEQ</strong>, 否则无法启用</mark></p></li>
</ul>
<p><img alt="AEQ节点配置" src="../../../_images/aeq_stream_node.png" /><br>
<br></p>
</section>
<section id="id45">
<h3><span class="section-number">2.7.2.9.4. </span>调试方法<a class="headerlink" href="#id45" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>自适应EQ参数配置及调试方法：参考以下文档，导出anc_ext.bin下载到小机</p>
<ul>
<li><p>单次耳道自适应EQ：参考《JL耳道自适应调试指南》</p></li>
<li><p>实时自适应EQ：参考《JL实时自适应调试指南》</p></li>
</ul>
</li>
<li><p>anc_ext.bin 文件路径：.\SDK\cpu\br**\tools\anc_ext.bin</p></li>
</ul>
</section>
<section id="id46">
<h3><span class="section-number">2.7.2.9.5. </span>API使用说明<a class="headerlink" href="#id46" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//(实时)自适应EQ打开</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_real_time_adaptive_eq_open</span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="n">audio_adaptive_fre_sel</span><span class="w"> </span><span class="n">fre_sel</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">result_cb</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">));</span>

<span class="c1">//(实时)自适应EQ退出</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_real_time_adaptive_eq_close</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="c1">//查询AEQ的状态</span>
<span class="n">u8</span><span class="w"> </span><span class="nf">audio_adaptive_eq_state_get</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   自适应EQ滤波器模式设置</span>
<span class="cm">   param: mode 0 默认参数； 1 自适应参数</span>
<span class="cm">   note: 需注意，调用该接口后，全局有效，如使用默认参数，则下次自适应也不会更新参数</span>

<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_adaptive_eq_eff_set</span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="n">ADAPTIVE_EFF_MODE</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>

<span class="c1">//删除AEQ 自适应系数记忆链表，需等下次自适应输出才有自适应参数</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_adaptive_eq_cur_list_del</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

</pre></div>
</div>
</section>
<section id="id47">
<h3><span class="section-number">2.7.2.9.6. </span>示例代码<a class="headerlink" href="#id47" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>单次自适应EQ （+ 其他算法）</strong></p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径 ： icsd_demo.c</span>

<span class="cm">/*</span>
<span class="cm">    单次（自适应EQ）</span>
<span class="cm">        播放提示音，输出EQ滤波器</span>
<span class="cm">    note  : 播提示音 + 自适应EQ, 运行结束调用audio_adaptive_eq_end_result</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_adaptive_eq_app_open</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">    单次（ANC耳道自适应 + 自适应EQ + 贴合度检测）</span>
<span class="cm">        播放提示音，输出EQ滤波器 + ANC滤波器，贴合度检测结果</span>
<span class="cm">    note  : ANC耳道自适应输出的SZ，挂载多个算法处理</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_ear_adaptive_app_open_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>实时自适应EQ + RTANC</strong></p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径 ： icsd_demo.c</span>

<span class="cm">/*</span>
<span class="cm">    实时（RTANC + 自适应EQ）</span>
<span class="cm">        实时监测耳道，自适应调整EQ和ANC滤波器</span>
<span class="cm">    note  : 由ANC实时自适应输出的SZ，挂载多个算法处理</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">audio_real_time_adaptive_app_open_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm">    关闭实时（RTANC + 自适应EQ）</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">audio_real_time_adaptive_app_close_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id48">
<h3><span class="section-number">2.7.2.9.7. </span>FAQ<a class="headerlink" href="#id48" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Q：自适应 EQ参数 有效业务场景是哪些？</strong></p>
<ul>
<li><p>A：依赖于数据流<code class="docutils literal notranslate"><span class="pre">AEQ</span></code>名称的EQ节点，默认仅有<code class="docutils literal notranslate"><span class="pre">媒体</span></code>数据流场景生效</p></li>
</ul>
</li>
<li><p><strong>Q：EQ参数自适应后是否保留？</strong></p>
<ul>
<li><p>A：每次自适应EQ参数输出成功后，会自动保存到RAM，下次启动后会自动加载，掉电不保存；</p></li>
</ul>
</li>
<li><p><strong>Q：如何切到默认EQ参数，或清除自适应EQ参数？</strong></p>
<ul>
<li><p>A: 调用audio_adaptive_eq_eff_set(AEQ_EFF_MODE_DEFAULT)，即可切到默认EQ参数；调用audio_adaptive_eq_cur_list_del()，即可清除自适应EQ参数；</p></li>
</ul>
</li>
<li><p><strong>Q：有多组EQ音效是否需要匹配多个自适应EQ参数？</strong></p>
<ul>
<li><p>A：不需要，自适应EQ是独立的EQ节点，其参数由算法根据佩戴状态生成，与其他EQ节点的参数无关；</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="id49">
<h2><span class="section-number">2.7.2.10. </span>全时/实时自适应<a class="headerlink" href="#id49" title="Link to this heading"></a></h2>
<section id="id50">
<h3><span class="section-number">2.7.2.10.1. </span>功能简介<a class="headerlink" href="#id50" title="Link to this heading"></a></h3>
<p>ANC降噪效果与耳机佩戴松紧度，以及用户的耳道差异息息相关；耳道自适应技术，通过麦克风收集用户耳道特性和佩戴情况的声学特征信息，自适应调整降噪参数，以提供更加舒适和个性化的降噪体验；</p>
<ul class="simple">
<li><p>优势：实时检测，补全不同人耳道的佩戴差异</p></li>
<li><p>触发方式：启动后实时监测</p></li>
<li><p>输入：耳道/佩戴信息</p></li>
<li><p>输出：调滤波器/增益</p></li>
</ul>
</section>
<section id="id51">
<h3><span class="section-number">2.7.2.10.2. </span>系统/硬件支持<a class="headerlink" href="#id51" title="Link to this heading"></a></h3>
<p><strong>（1）支持方案</strong><br></p>
<ul class="simple">
<li><p><strong>TWS 3MIC 方案（TALK+FF+FB）：推荐方案，较好兼容自讲场景</strong></p>
<ul>
<li><p>使用3个麦：TALK MIC、FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
<li><p><strong>TWS 2MIC 方案（TALK+FF+FB）：</strong></p>
<ul>
<li><p>使用2个麦：FF MIC、FB MIC做检测；<br></p></li>
</ul>
</li>
</ul>
<p><strong>（2）CPU平台差异</strong><br></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性</p></th>
<th class="head"><p>700N</p></th>
<th class="head"><p>701N</p></th>
<th class="head"><p>708N</p></th>
<th class="head"><p>709N</p></th>
<th class="head"><p>710N</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>实时自适应</p></td>
<td><p>×</p></td>
<td><p>×</p></td>
<td><p>×</p></td>
<td><p>√</p></td>
<td><p>×</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id52">
<h3><span class="section-number">2.7.2.10.3. </span>软件配置<a class="headerlink" href="#id52" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>实时自适应参数保存配置</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">   RTANC 开关或模式切换时，是否保持上一次的效果参数, 工具/产测流程 固定使用默认参数</span>
<span class="cm">   0 使用默认参数</span>
<span class="cm">   1 参数保持，工具/产测使用默认参数</span>
<span class="cm">   2 参数保持(所有流程)，测试验证使用</span>
<span class="cm">*/</span>
<span class="cp">#define AUDIO_RT_ANC_KEEP_LAST_PARAM            1       </span><span class="c1">//启用后，默认保留RTANC CMP/FB参数</span>
<span class="cp">#define AUDIO_RT_ANC_KEEP_FF_COEFF              0       </span><span class="c1">//在以上宏的基础上选择是否保留RTANC FF参数</span>
</pre></div>
</div>
</section>
<section id="id53">
<h3><span class="section-number">2.7.2.10.4. </span>调试方法<a class="headerlink" href="#id53" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>实时耳道自适应参数配置及调试方法：参考《JL实时自适应调试指南》，导出anc_ext.bin下载到小机</p></li>
<li><p>anc_ext.bin 文件路径：.\SDK\cpu\br**\tools\anc_ext.bin</p></li>
</ul>
</section>
<section id="id54">
<h3><span class="section-number">2.7.2.10.5. </span>API使用说明<a class="headerlink" href="#id54" title="Link to this heading"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/*</span>
<span class="cm">   实时自适应ANC打开</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_real_time_adaptive_open</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   实时自适应ANC关闭</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_real_time_adaptive_close</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   实时自适应ANC挂起</span>
<span class="cm">   param:name 挂起名称标识</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_anc_real_time_adaptive_suspend</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   实时自适应ANC恢复</span>
<span class="cm">   param:name 恢复名称标识，需与挂起名称标识一致</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">audio_anc_real_time_adaptive_resume</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">   实时自适应ANC状态获取</span>
<span class="cm">*/</span>
<span class="n">u8</span><span class="w"> </span><span class="nf">audio_anc_real_time_adaptive_state_get</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

</pre></div>
</div>
</section>
<section id="id55">
<h3><span class="section-number">2.7.2.10.6. </span>示例代码<a class="headerlink" href="#id55" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>实时自适应EQ + RTANC</strong></p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径 ： icsd_demo.c</span>

<span class="cm">/*</span>
<span class="cm">    实时（RTANC + 自适应EQ）</span>
<span class="cm">        实时监测耳道，自适应调整EQ和ANC滤波器</span>
<span class="cm">    note  : 由ANC实时自适应输出的SZ，挂载多个算法处理</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">audio_real_time_adaptive_app_open_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm">    关闭实时（RTANC + 自适应EQ）</span>
<span class="cm">*/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">audio_real_time_adaptive_app_close_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id56">
<h3><span class="section-number">2.7.2.10.7. </span>FAQ<a class="headerlink" href="#id56" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong>Q：实时自适应关闭后，RTANC参数是否保留？</strong></p>
<ul>
<li><p>A：关闭RTANC，默认保留CMP/FB参数:</p>
<ul>
<li><p>若需要保留FF参数，需要在<code class="docutils literal notranslate"><span class="pre">rt_anc_app.h</span></code>中配置<code class="docutils literal notranslate"><span class="pre">AUDIO_RT_ANC_KEEP_FF_COEFF</span></code>为1；</p></li>
<li><p>如不需要保留RTANC参数，需要在<code class="docutils literal notranslate"><span class="pre">rt_anc_app.h</span></code>中配置<code class="docutils literal notranslate"><span class="pre">AUDIO_RT_ANC_KEEP_LAST_PARAM</span></code>为0</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Q：实时自适应需要保持anc fade gain = 16384(0dB)</strong></p>
<ul>
<li><p>A：因此当触发调anc fade gain行为，均会挂起RTANC，比如风噪检测、环境自适应、手动调fade增益档位等；</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="id57">
<h2><span class="section-number">2.7.2.11. </span>算法业务场景互斥<a class="headerlink" href="#id57" title="Link to this heading"></a></h2>
<section id="id58">
<h3><span class="section-number">2.7.2.11.1. </span>算法功能开关控制逻辑<a class="headerlink" href="#id58" title="Link to this heading"></a></h3>
<section id="id59">
<h4><span class="section-number">2.7.2.11.1.1. </span>设计意义<a class="headerlink" href="#id59" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>用于解决因需求不同或资源不足，需要在不同业务场景下，裁剪ANC算法功能：</p>
<ul>
<li><p>例：某方案因资源不足，需要在空间音效、通话场景关闭风噪检测、RTANC等</p></li>
</ul>
</li>
<li><p>用户层可使用按键/手机APP 独立控制各类算法</p></li>
<li><p>算法控制优先级：场景限制 &gt; 用户层APP控制 &gt; ANC模式切换 默认启用算法类型</p></li>
</ul>
</section>
<section id="id60">
<h4><span class="section-number">2.7.2.11.1.2. </span>策略说明<a class="headerlink" href="#id60" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><mark><strong>适用</strong>本策略的算法</mark></p>
<ul>
<li><p>智能免摘、风噪检测、广域点击、环境自适应、啸叫检测、RTANC 等ADT相关算法</p></li>
</ul>
</li>
<li><p><mark><strong>不适用</strong>本策略的算法</mark></p>
<ul>
<li><p>单次耳道自适应、单次CMP、单次AEQ、贴合度检测<br>
<img alt="算法功能使能逻辑" src="../../../_images/anc_ext_open_check.png" /><br>
<br></p></li>
</ul>
</li>
<li><p>APP 功能开关：即用户层调用各类算法的接口，在各功能<code class="docutils literal notranslate"><span class="pre">API使用说明</span></code>、<code class="docutils literal notranslate"><span class="pre">示例代码</span></code> 的接口，，比如<code class="docutils literal notranslate"><span class="pre">audio_anc_real_time_adaptive_open</span></code></p></li>
<li><p>APP 启动功能标志更新：记录当前用户层启动了什么算法；</p></li>
<li><p>业务场景检查：根据 <code class="docutils literal notranslate"><span class="pre">audio_anc_manager.c</span></code> 的 <code class="docutils literal notranslate"><span class="pre">anc_ext_support_scene</span></code>数组，判断当前业务场景是否支持该算法，做进一步筛选，是否允许启动；</p></li>
<li><p>算法启动：启动ANC_EXT相关算法；</p></li>
<li><p>ANC模式切换：切换通透、降噪、关闭模式</p></li>
<li><p>APP 启动标志检查：如检查存在功能标志，则会经过业务场景检查，并启动此标志对应算法；</p></li>
</ul>
</section>
<section id="id61">
<h4><span class="section-number">2.7.2.11.1.3. </span>业务场景检查<a class="headerlink" href="#id61" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>业务场景数组说明</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//文件路径：icsd_adt_app.h</span>

<span class="c1">//ANC扩展功能场景支持定义</span>
<span class="k">enum</span><span class="w"> </span><span class="n">ICSD_ADT_SCENE</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//-------USER SCENE------------</span>
<span class="w">    </span><span class="n">ADT_SCENE_IDEL</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">ADT_SCENE_A2DP</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w">	</span><span class="c1">//A2DP场景</span>
<span class="w">    </span><span class="n">ADT_SCENE_ESCO</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w">	</span><span class="c1">//ESCO场景</span>
<span class="w">    </span><span class="n">ADT_SCENE_MIC_EFFECT</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w">	</span><span class="c1">//MIC混响场景</span>
<span class="w">    </span><span class="n">ADT_SCENE_TONE</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w">	</span><span class="c1">//提示音场景(未启用)</span>
<span class="w">    </span><span class="n">ADT_SCENE_ANC_OFF</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w">	</span><span class="c1">//ANC_OFF场景</span>
<span class="w">    </span><span class="n">ADT_SCENE_ANC_TRANS</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w">	</span><span class="c1">//通透场景</span>
<span class="w">    </span><span class="c1">//用户定义场景在此添加</span>

<span class="w">    </span><span class="c1">//------SDK FIX SCENE 默认不支持ADT---------</span>
<span class="w">    </span><span class="n">ADT_SCENE_AFQ</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
<span class="w">    </span><span class="n">ADT_SCENE_PRODUCTION</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span>
<span class="p">};</span>


<span class="c1">// 文件路径：audio_anc_manager.c</span>

<span class="cm">/*</span>
<span class="cm">   配置不同业务场景下支持ANC_EXT 算法功能</span>
<span class="cm">   1、ANC模式、IDLE场景默认全支持</span>
<span class="cm">   2、多场景共存时，以不支持的场景优先</span>
<span class="cm">   3、数组修改注意</span>
<span class="cm">   		1）scene 需与枚举 enum ICSD_ADT_SCENE 的 USER SCENE 对齐</span>
<span class="cm">   		2）算法  需与枚举 enum ICSD_ADT_MODE  对齐</span>
<span class="cm">*/</span>
<span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">anc_ext_support_scene</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//0-智能免摘 1-风噪检测 2-广域点击 3-NULL 4-RTANC 5-入耳检测 6-环境自适应 7-NULL 8-NULL 9-啸叫检测</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//A2DP场景</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//ESCO场景</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//MIC混响场景</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//提示音场景</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//ANC_OFF场景</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">1</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//通透场景</span>
<span class="w">    </span><span class="c1">//用户可在此添加其他场景，注意修改数组大小以及对齐枚举ICSD_ADT_SCENE的 USER SCENE</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>新增业务场景关联案例<br></p>
<ul>
<li><p>因某方案ram不足，空间音效只能开风噪检测</p></li>
</ul>
</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*-----------------Step 1 新增场景定义-----------------*/</span>
<span class="k">enum</span><span class="w"> </span><span class="n">ICSD_ADT_SCENE</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//-------USER SCENE------------</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="c1">//用户定义场景在此添加</span>
<span class="w">    </span><span class="n">ADT_SCENE_SPACE_EFFECT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w">	</span><span class="c1">//空间音效场景</span>

<span class="w">    </span><span class="c1">//------SDK FIX SCENE 默认不支持ADT---------</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">};</span>


<span class="cm">/*-----------------Step 2 新增场景支持定义-------------*/</span>
<span class="k">const</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">anc_ext_support_scene</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//0-智能免摘 1-风噪检测 2-广域点击 3-NULL 4-RTANC 5-入耳检测 6-环境自适应 7-NULL 8-NULL 9-啸叫检测</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="c1">//用户可在此添加其他场景，注意修改数组大小以及对齐枚举ICSD_ADT_SCENE的 USER SCENE</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">1</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">      </span><span class="mi">0</span><span class="p">,</span><span class="w">         </span><span class="mi">0</span><span class="p">,</span><span class="w">           </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="mi">0</span><span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="c1">//空间音效场景</span>
<span class="p">};</span>


<span class="cm">/*-----------------Step 3 场景启动关联-----------------*/</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_space_effect_open</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w">   </span><span class="c1">//空间音效 启动（伪代码）</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//开启空间音效场景</span>
<span class="w">    </span><span class="n">audio_icsd_adt_scene_set</span><span class="p">(</span><span class="n">ADT_SCENE_SPACE_EFFECT</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//复位ANC算法</span>
<span class="w">    </span><span class="n">audio_icsd_adt_reset</span><span class="p">(</span><span class="n">ADT_SCENE_SPACE_EFFECT</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//空间音效开启流程...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">audio_space_effect_close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w">   </span><span class="c1">//空间音效 关闭（伪代码）</span>
<span class="p">{</span><span class="w">    </span>
<span class="w">    </span><span class="c1">//空间音效关闭流程...</span>

<span class="w">    </span><span class="c1">//关闭空间音效场景</span>
<span class="w">    </span><span class="n">audio_icsd_adt_scene_set</span><span class="p">(</span><span class="n">ADT_SCENE_SPACE_EFFECT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//复位ANC算法</span>
<span class="w">    </span><span class="n">audio_icsd_adt_reset</span><span class="p">(</span><span class="n">ADT_SCENE_SPACE_EFFECT</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ANC 默认启动算法控制</p>
<ul>
<li><p>可根据ANC默认切换模式的需求，修改此函数</p></li>
</ul>
</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// 文件路径：audio_anc_manager.c</span>

<span class="c1">//ANC模式切换时，启动算法功能 - 后续可被模块单独开关替代</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">audio_anc_app_adt_mode_init</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id62">
<h2><span class="section-number">2.7.2.12. </span>扩展功能打印控制<a class="headerlink" href="#id62" title="Link to this heading"></a></h2>
<section id="id63">
<h3><span class="section-number">2.7.2.12.1. </span>基本描述<a class="headerlink" href="#id63" title="Link to this heading"></a></h3>
<p>ANC扩展功能的打印非常多，默认不常开；但在debug，尤其性能相关的问题，需要打开并提供相关打印信息给原厂算法同事，才能较好的还原问题现场，协助分析问题。</p>
</section>
<section id="id64">
<h3><span class="section-number">2.7.2.12.2. </span>打印控制位置<a class="headerlink" href="#id64" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>APP层打印 - 文件icsd_common_v2_app.h</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="c1">//============ANC_EXT APP打印管理=========</span>
<span class="cp">#define ICSD_ADT_RTANC_OFFLINE_PRINTF      1   </span><span class="c1">//RTANC 离线log 使能 （200ms/次）</span>
<span class="cp">#define ICSD_WIND_LVL_PRINTF               1   </span><span class="c1">//风噪阈值打印使能</span>
<span class="cp">#define ICSD_ENV_LVL_PRINTF                1   </span><span class="c1">//环境自适应阈值打印使能</span>

</pre></div>
</div>
<ul class="simple">
<li><p>算法层打印 - 文件icsd_common_v2.h</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//============算法库轻量信息打印使能=========</span>
<span class="cp">#define ICSD_ADT_LOG_EN                    0</span><span class="c1">//ADT公共部分</span>
<span class="cp">#define ICSD_HOWL_LOG_EN                   0</span><span class="c1">//啸叫检测</span>
<span class="cp">#define ICSD_RTANC_LOG_EN                  1</span><span class="c1">//实时自适应</span>

<span class="c1">//============算法库打印使能=================</span>
<span class="cp">#define ADT_PRINTF_EN                      0 </span><span class="c1">//ADT资源</span>
<span class="cp">#define VDT_PRINTF_EN                      0 </span><span class="c1">//智能免摘</span>
<span class="cp">#define WAT_PRINTF_EN                      0 </span><span class="c1">//广域点击</span>
<span class="cp">#define CMP_PRINTF_EN                      0 </span><span class="c1">//自适应CMP</span>
<span class="cp">#define AEQ_PRINTF_EN                      0 </span><span class="c1">//自适应EQ</span>
<span class="cp">#define AFQ_PRINTF_EN                      0 </span><span class="c1">//AFQ</span>
<span class="cp">#define AVC_PRINTF_EN                      0 </span><span class="c1">//AVC</span>
<span class="cp">#define DOT_PRINTF_EN                      0 </span><span class="c1">//松紧度检测</span>
<span class="cp">#define EIN_PRINTF_EN                      0 </span><span class="c1">//</span>
<span class="cp">#define HOWL_PRINTF_EN                     0 </span><span class="c1">//啸叫检测</span>
<span class="cp">#define RTANC_RTPRINTF_EN                  0 </span><span class="c1">//实时自适应ANC RT</span>
<span class="cp">#define RTANC_HZPRINTF_EN                  0 </span><span class="c1">//实时自适应ANC HZ</span>
<span class="cp">#define ADJDCC_PRINTF_EN                   0 </span><span class="c1">//自适应DCC</span>


<span class="c1">//===========风噪调试使能====================</span>
<span class="cp">#define WDT_PRINTF_EN                      0 </span><span class="c1">//算法打印</span>
<span class="cp">#define ICSD_WDT_LOG_EN                    0 </span><span class="c1">//离线log打印</span>
<span class="cp">#define WDT_LFF_TLK_DEBUG_EN               0 </span><span class="c1">//LFF_TLK模式离线调试打印</span>
<span class="cp">#define WDT_LFF_LFB_DEBUG_EN               0 </span><span class="c1">//LFF_LFB模式离线调试打印</span>
<span class="cp">#define WDT_LFF_RFF_DEBUG_EN               0 </span><span class="c1">//LFF_RFF模式离线调试打印</span>

</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ANC_cfg.html" class="btn btn-neutral float-left" title="2.7.1. ANC使用配置" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ANC_AntiSat_cfg.html" class="btn btn-neutral float-right" title="2.7.3. ANC防破音配置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2026, 杰理科技股份有限公司.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>