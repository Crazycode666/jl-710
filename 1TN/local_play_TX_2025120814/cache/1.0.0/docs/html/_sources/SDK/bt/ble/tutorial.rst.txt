BLE开发简介
############

核心特点：与经典蓝牙的区别
~~~~~~~~~~~~~~~~~~~~~~~~~~
BLE的设计初衷与经典蓝牙（如连接耳机、音箱的传统蓝牙）不同，其核心区别如下：

=============== ============================================= =====================================
      特性                   蓝牙低功耗                                       经典蓝牙
      目标	                  间歇性传输少量数据                      持续传输大量数据（音频、文件）
      功耗          极低，一颗纽扣电池可运行数月甚至数年                     较高，需要频繁充电
      延迟    	   非常短（仅需几毫秒即可建立连接）                         相对较长
   数据吞吐量      较低（适合传感器读数、指令等小数据包）      	      较高（适合音频流、大数据传输）
    典型应用      智能手表、健康手环、 Beacon、智能家居传感器     	 无线耳机、音箱、车载电话、文件传输
=============== ============================================= =====================================

简单来说：

#. 经典蓝牙 像是一根持续流水的大水管，适合传输大量数据，但耗电。

#. BLE 像是一个滴水的水龙头，只在需要时滴几滴，极其省电。

BLE角色
~~~~~~~~~~~~~~~~~~~~~~~~~~

BLE设备通常采用客户端-服务器架构，在 BLE 术语中称为：

外围设备：也称为 从设备
=============

#. 它是数据的提供者（服务器）。

#. 通常是传感器或小设备，如耳机、音箱、手表。

#. 它广播自身的存在和一些基本信息。

#. 功耗极低。

中央设备：也称为 主设备
=============

#. 它是数据的消费者（客户端）。

#. 通常是功能更强大的设备，如智能手机APP、手表。

#. 它扫描周围正在广播的外围设备，发现后可以发起连接并读取或接收数据。

BLE广播
~~~~~~~~~~~~~~~~~~~~~~~~~~
外围设备在不建立连接的情况下，周期性地发送小数据包（内容：LTV格式，最多31字节），让周围的中央设备能发现它。

========== ============================================ ======================================================================
   特性                      Adv广播                                              Rsp广播（扫描响应）
  发起方	                 外围设备	                                   外围设备（但由中央设备的扫描请求触发）
   目的	        宣告自身存在，提供最基本的信息                           提供附加信息，回应中央设备的查询
  必要性	           必须存在，否则无法被发现                                  可选，设备可以不支持此功能
 数据容量	               31字节                                                    31字节
 工作模式	          单向，像无线电广播                                        双向交互，一问一答
 功耗考量	         发送频率决定主要功耗                                仅在收到请求时回复，增加功耗极微
 典型内容	   设备地址、发射功率、短名称、核心服务UUID                完整设备名称、更多服务UUID、厂商自定义数据
========== ============================================ ======================================================================

.. code-block:: c

      // 设置ble广播包写法如下：

      // 1、有第三方协议中间层写法，参考rcsp：
      // adv包
      app_ble_adv_data_set(rcsp_server_ble_hdl, buf, 31);
      // rsp包
      app_ble_rsp_data_set(rcsp_server_ble_hdl, buf, 31);
      
      // 2、无第三方协议中间层写法，参考rcsp：
      // adv包
      ble_op_set_adv_data(31, buf);
      // rsp包
      ble_op_set_rsp_data(offset, buf);

      // 开启、关闭ble广播：
      // 1、有第三方协议中间层写法，参考rcsp：
      app_ble_adv_enable(rcsp_server_ble_hdl, en);
      
      // 2、无第三方协议中间层写法，参考rcsp：
      ble_user_cmd_prepare(BLE_CMD_ADV_ENABLE, 1, en);



实际应用中的策略，为什么要把广播分成两种？
=============

#. 降低功耗：核心的、最重要的信息（比如设备地址）必须每次广播都发送。而次要信息（比如完整名称）只在有设备真正感兴趣并询问时才发送。这避免了每次广播都发送大量数据，显著降低了平均功耗。

#. 提高效率：广播信道是所有设备共享的。更短的Adv广播包占空比更小，冲突更少，信道利用率更高。

因此，当你用手机扫描BLE设备时，看到的完整设备名和所有服务信息，通常是手机在收到Adv广播后，发送扫描请求，并收到扫描响应之后才组合显示出来的。

BLE服务与特征
~~~~~~~~~~~~~~~~~~~~~~~~~~

BLE服务
=============
服务是一个数据的容器，用于实现设备的一个特定功能或一组相关数据。它本身不做什么，而是将相关的数据（特征）组织在一起。

如rcsp服务。

BLE特征
=============

特征是服务内部的实际数据值和操作对象。它是客户端（如手机）与服务器（如耳机、音箱、手表）进行读写交互的真正实体。

========================== ============ ==============================================================
          属性                 说明                               类比
          Read                 读取                  医生查看你的化验报告（从设备读数据）
          Write                写入                 医生开具处方单（向设备发送指令）
         Notify               通知            医院主动打电话告诉你报告出来了（设备主动向手机推送数据，最省电）
        Indicate              指示                   Notify类似，但需要客户端回复确认，更可靠
  Write without response     无响应写入	   把信扔进邮筒，不关心是否收到（发送指令，不等待回复，速度快）
========================== ============ ==============================================================

如rcsp服务的写特征和通知特征。

结构关系图
=============

以rcsp为例：

.. code-block:: c

      设备 (Device)
      |
      └─── 服务 (Service) [rcsp服务 (0xae00)]
      |
      ├─── 特征 (Characteristic) [中央设备发送数据  (0xae01)]
      |    └───  属性: WRITE_WITHOUT_RESPONSE
      |
      └─── 特征 (Characteristic) [中央设备接收数据 (0xae02)]
            └─── 属性: NOTIFY

.. tip:: 
      以上服务特征值（0xae00、0xae01、0xae02），是固件设备开发人员与手机APP开发人员协商使用什么值的。

- 服务特征开发说明详细见：

  - make_gatt_services-v1.2.1.rar :download:`点击下载<docs/make_gatt_services-v1.2.1.rar>`
  - rcsp_profile.rar :download:`点击下载<docs/rcsp_profile.rar>`

